# UnitTestOf
This project implements test mocking and verification with source code generation.
It was created to answer the question: <b>Is source code generation the best way to do mocking for unit tests?</b> -
this is a different strategy to established libraries such as  [mockk](https://docs.oracle.com/javase/7/docs/technotes/guides/apt/index.html) and
and [mockito](https://docs.oracle.com/javase/7/docs/technotes/guides/apt/index.html) which use byte code generation. 

This is a proof of concept and the capabilities of <b>UnitTestOf</b> are limited to the styles in contained sample projects.
Despite this <b>UnitTestOf</b> has capabilities not available in other libraries, such as the elimination of boilerplate code for test context and argument capture. 
Adding new, novel features like this is relatively easy because generated coded is based on templates using kotlin string interpolation.

The source code processor can generate kotlin code via [ksp](https://kotlinlang.org/docs/ksp-overview.html)
or [kapt](https://kotlinlang.org/docs/kapt.html) or java code via [apt](https://docs.oracle.com/javase/7/docs/technotes/guides/apt/index.html).  

Kotlin examples are provided in kotlin in project <b>sampletarget</b>. Java example are in project <b>sampletargetj</b>.
Sample tests are repeated with [mockk](https://docs.oracle.com/javase/7/docs/technotes/guides/apt/index.html) for kotlin comparisons 
and [mockito](https://docs.oracle.com/javase/7/docs/technotes/guides/apt/index.html) for java.

My takeout from this exercise is that mocking with source code generation, although marginally slower than traditional mocking, is the best strategy because it opens up
new possibilities such as the elimination of boilerplate code.  


## Building
<pre>
# build the support library
cd unittestof/annotations
gradle clean publishToMavenLocal
# build the annotation processor
cd ../kspprocessor/
gradle clean publishToMavenLocal
# run the kotlin tests
cd ../sampletarget
gradle clean build
# run the java tests
cd ../sampletargetj
gradle clean build
</pre>

## Limitations
Test targets are assumed to be of this format - all dependencies are interfaces identified in their constructor:

In Kotlin:
<pre>
class Bean2(val service1: IService1, val service2: IService2)
</pre>
in java:
<pre>
public class Bean2 {
    public Bean2(IService1 service1, IService2 service2, IService3 service3) {
       ....
</pre>

## Style

### Test Context / Boilerplate code

To create a unit test mark the test class with <b>UnitTest</b> annotation and 
specify target with the <b>UnitTestOf</b> annotation.  
This will result in the boilerplate code for mocking being generated automatically in a <b>**TestContext</b> class.   
e.g.:
<pre>
@UnitTest
class SampleBean1UnitTest : UnitTestOf&lt;Bean1> {
   // class Bean1TestContext is autogenerated
   lateinit var context : Bean1TestContext
</pre>
instances of the context have a target (for the test) instance and service recorders
to control mocking and validate behaviour
<pre>
 @Test
    //verify params sent to services with captured
    fun testLooseArgMatchingVerifyCallsWithCaptured() {
        context = BeanTestContext()
        // each service dependency has a recorder instance
        // each service dependency method has a "when" peer
        // this uses the when peer for service1.sayHello 
        context.service1Recorder.whenSayHello(any(), any(), "tweeet")
        // the context contains a test target
        val greeting = context.target.officialGreet(listOf(Pair("Mr", "Pigeon")))
        assertEquals(greeting, "tweeet")
        // each service dependency method has a "capture" peer method defined with a custom return structure for each method 
        assertEquals(
            IService1ProxyContext.sayHello_String_StringParams("Mr", "Pigeon"), 
            context.service1Recorder.captureSayHello(any(), any()).get(0)
        )
    }
</pre>

## Comparisons
The timings here are produced by running test projects <b>sampleproject</b> and <b>sampleprojectj</b>, with option 
<b>. ./gradlew clean build --profile</b> 
2 times (first time to get gradle warmed up) on a laptop running MS Windows Pro with 32Gb physical memory,
1TB M.2 2280 PCIe Solid State Drive, 8th Generation Intel Core i9-8950HK Processor (12MB Cache, up to 4.8 GHz, 6 cores).
This command results build timings in <b>build/reports/profile/profile*.html</b> and more detailed test timings in
<b>build/reports/tests/test/index.html</b>.  Times are in seconds.
The takeout from these comparisons is that there is little difference in build times between different mocking approaches however
improved capabilites such as the elimination of boilerplate code are relatively cheaper with source code generation. 

### Kotlin - Comparison  Mockk / UnitTestOf with kapt / UnitTestOf with ksp
This comparison is defined in testproject: <b>sampletarget</b>.
To run kapt test the kapt plugin + depeddency is uncommented in <b>build.gradle.kts</b>, similarly for the ksp test.

| -                                          | UnitTestOf - ksp                         |              UnitTestOf - kapt              |                    mockk                     |
|--------------------------------------------|------------------------------------------|:-------------------------------------------:|:--------------------------------------------:|
| proxy strategy                             | source code generation                   |           source code generation            |             byte code generation             |
| settings (in <b>sampletarget/build.gradle.kts</b>) | useKapt=false, useKsp=true, useMockk=false |  useKapt=false, useKsp=true,useMockk=false  | useKapt=false, userKsp=false, useMockk=true  |
| total build time                           | 4.547                                    |                    4.592                    |                    4.390                     |
| capture style                              | automatically generated prebuilt structures | automatically generated prebuilt structures |             manually coded slots             |
| verification by example                    | yes                                      |                     yes                     |                     yes                      |
| test context boiler plate                  | automatically generated                  |           automatically generated           |                manually coded                |
| compileTestKotlin                          | 1.781                                    |                    1.320                    |                    0.980                     |
| test phase                                 | 0.678                                    |                    0.650                    |                    1.915                     |
| time in user test code                     | 0.100                                    |                    0.100                    |                    0.965                     |
| compileKotlin                              | 0.655                                    |                    0.582                    |                    0.588                     |
| kspTestKotlin                              | 0.492                                    |                     N/A                     |                     N/A                      |
| kaptGenerateStubsKotlin                    | N/A                                      |                    0.191                    |                     N/A                      |
| kaptGenerateStubsTestKotlin                | N/A                                      |                    0.525                    |                     N/A                      |
| kaptTestKotlin                             | N/A                                      |                    0.223                    |                     N/A                      |
| kaptKotlin                                 | N/A                                      |                    0.026                    |                     N/A                      |

### Java - Comparison  Mockito / UnitTestOf with apt
This comparison is defined in project sampletargetj.  Setting useUnitTestOfExtra=true is for features that UnitTestOf has but mockito doesnt, hence not relevant for comparison of timings.

| -                                                  |                        UnitTestOf - apt                        |                                                    mockito                                                    |
|----------------------------------------------------|:--------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------:|
| proxy strategy                                     |                     source code generation                     |                                             byte code generation                                              |
| settings (in <b>sampletarget/build.gradle.kts</b>) | useUnitTestOf=true, useMockito=false, useUnitTestOfExtra=false |                        useUnitTestOf=true, useMockito=false, useUnitTestOfExtra=false                         |
| total build time                                   |                             1.754                              |                                                     1.619                                                     
| capture style                                      |          automatically generated prebuilt structures           | manually coded                                                                                             no |
| verification by example                            |                              yes                               |                                                      no                                                       |
| test context boiler plate                          |                    automatically generated                     |                                                manually coded                                                 |
| test                                               |                             0.694                              |                                                     0.713                                                     |
| time in user test code                             |                             0.056                              |                                                     0.099                                                     |
| compileTestJava                                    |                             0.222                              |                                                     0.082                                                     |
| compileJava                                        |                             0.075                              |                                                     0.076                                                     |
| 

### Sample Generated Code

Kotlin sample [here](docs/samplegeneratedcode/kotlin) 

Java sample [here](docs/samplegeneratedcode/java) 
